{% extends 'common/panel.html' %}
{% load humanize %}
{% load set_var %}
{% load percentage %}
{% load sortcosts %}
{% load flatblock_tags %}
{% block title %}{{instance.name}}{% endblock title %}
{% block panel %}

{% block progress %}
<input type="hidden" id="selected_progress_url" value="{% url analysis-progress instance.uid %}" />
{% if not instance.done %}
<div class="alert alert-info" 
     data-bind="visible: !done(), css: {'alert-error': error(), 'alert-info': !error()}">
    <div id="scenario_progress_html">
        <p data-bind="html: progressHtml"><!-- {{ instance.status_html|safe }} --></p>
    </div>
    <div class="progress progress-info progress-striped active" data-bind="visible: !error()">
        <div class="bar" data-bind="style: { width: progressBarWidth() }"></div>
    </div>
</div>
{% endif %}
{% endblock progress %}

<div class="tabbable">
    <ul class="nav nav-tabs" style="margin-bottom:0px;">
        <li class="active"><a href="#Inputs" data-toggle="tab"><span>{% flatblock 'show-inputs' 3600 %}</span></a></li>
        {% if instance.done %}
        <li><a href="#summary" data-toggle="tab"><span>{% flatblock 'show-results-summary' 3600 %}</span></a></li>
        <li><a href="#species" data-toggle="tab"><span>{% flatblock 'show-conservation-features' 3600 %}</span></a></li>
        <li><a href="#watersheds" data-toggle="tab"><span>{% flatblock 'show-planning-units' 3600 %}</span></a></li>
        {% endif %}
    </ul>

    {% set results = instance.results %}
    <div class="tab-content">

        <div id="Inputs" class="tab-pane active">
            <div class="box">
                <h4>Name</h4> 
                <p>{{ instance.name }}</p>
                {% if instance.description %}
                <h4>Description/Notes</h4>
                <p> {{instance.description}} </p>
                {% endif %}
            </div>

            <div>
             <table class="table">
             <thead> 
                <th><h4>{% flatblock 'show-conservation-features' 3600 %}</h4></th>
                <th>Goal</th> 
                <th>Importance Weighting</th>
             </thead>
             <tbody>
                {% for k,v in results.targets_penalties.items %}
                <tr class="{% if v.target > 0 %}targeted{% else %}not-targeted{% endif %}"> 
                    <td><strong>{{k}}</strong></td>
                    <td>{{v.target|percentage}}</td>
                    <td>{{v.penalty}}</td>
                </tr>
                {% endfor %}
             </tbody>
             </table>

             <!-- 
             <a href="#" class="btn btn-mini" id="btn-show-not-targeted">
                Toggle {% flatblock 'show-conservation-features' 2600 %} without goals.
             </a>
             <script> 
                $('a#btn-show-not-targeted').click( function(e) { 
                    e.preventDefault(); 
                    $('tr.not-targeted').toggle();
                });
             </script>
             -->
             <hr/>

             <table class="table">
                 <thead> <th><h4>Prioritization Constraints</h4></th><th></th></thead>
             {%for k,v in results.costs.items|sortcosts %}
             {% if v > 0%}<tr><td> &#10003; <strong>{{k}}</strong></td></tr> 
             {% else %}<tr><td> &nbsp; <del>{{k}}</del></td></tr> 
             {% endif %} 
             {%endfor%}
             </table>
             
             <span style="display:none" id="estimated_scaling_factor">{{instance.input_scalefactor}}</span>
            </div>
        </div>

        {% if instance.done %}
        <div id="summary" class="tab-pane">
            <div class="box">
                <p>The optimum prioritization scenario includes {{results.num_units}} {% flatblock 'show-planning-units' 3600 %} covering {{results.area|floatformat:0|intcomma}} km<sup>2</sup>. </p>
                <p>Goals were met for {{results.num_met}} of {{results.num_species}} {% flatblock 'show-conservation-features' 3600 %}.</p>
            </div>
        </div>

        <div id="watersheds" class="tab-pane">
            <div class="box">
                <p>The optimum prioritization scenario includes {{results.num_units}} {% flatblock 'show-planning-units' 3600 %} covering {{results.area|floatformat:0|intcomma}} km<sup>2</sup>. </p>
                <table class="table" summary="Subbasin Table">
                <thead>
                    <tr>
                    <th scope="col"> {% flatblock 'show-planning-units' 3600 %} </th> 
                    {%for k,v in results.costs.items %}
                        {% if v > 0 %}
                        <th scope="col">{{k}}</th>
                        {% endif %}
                    {%endfor%}
                    <tr>
                </thead>
                <tbody id="best-pus">
                {% for w in results.units %}
                <tr>
                    <td>{{w.name}}</td>
                    {%for k,v in w.costs.items %}
                    {% if v %}
                    <td> {{k}}:{{v}} </td>
                    {% endif %}
                    <td class="centroid-x" style="display:none">{{w.centroidx}}</td>
                    <td class="centroid-y" style="display:none">{{w.centroidy}}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
                </tbody>
                </table>
            </div>
             <script> 
                var best = $('tbody#best-pus');
                best.find('tr').mouseenter( function(e) { 
                    var x = $(this).find('td.centroid-x').html();
                    var y = $(this).find('td.centroid-y').html();
                    var lonLat = new OpenLayers.LonLat(x,y);
                    markers.addMarker(new OpenLayers.Marker(lonLat));
                }).mouseleave( function(e) {
                    markers.clearMarkers();
                });
             </script>
        </div>
        <div id="species" class="tab-pane">
            <div class="box">
                <p>Goals were met for {{results.num_met}} of {{results.num_species}} {% flatblock 'show-conservation-features' 3600 %}.</p>
                <table class="table" id="species_table" summary="Species Table">
                <thead>
                    <tr>
                        <th scope="col"> Species </th>
                        <th scope="col"> Percent of Total </th>
                        <th scope="col" width="50"> Units </th>
                        <th scope="col" width="80"> Goal Met?</th>
                    </tr>
                </thead>
                <tbody>
                {% for s in results.species %}
                <tr{% if s.target == 0 %} class="nogoal" style="display:none;"{% else %}class="hit"{% endif %}>
                    <td> <strong>{{s.name}}</strong><br/>({{s.code}})</td>
                    <td> {{s.pcttotal|percentage:1}} </td>
                    <td> {{s.units}} </td>
                    <td> {% if s.target == 0 %} -- {% else %} 
                        {% if s.met %}&#10003;{% else %} NO<br/>(Goal was {{s.target_prop|percentage:0}}){% endif %} 
                         {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        </div>
    </div>

{% endblock panel %}
